<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <style type="text/tailwindcss">
        .dropdown-content {
            transform-origin: top;
            transform: scale(0.95);
            transition: all 0.1s ease-in-out;
        }
        .group:hover .dropdown-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <nav class="navbar shadow-md bg-[#1B3A57]">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo Section -->
                <!-- <div class="logo flex items-center">
                    <img src="../images/pwdi.png" alt="Company Icon" class="h-10 w-auto mr-2">
                    <span class="text-white text-2xl font-semibold">PWDi</span>
                </div> -->

                <a href="homepage.html">
                    <div class="logo flex items-center">
                        <img src="../images/nav_logo.png" alt="Company Icon" class="h-8 w-auto mr-2">
                        <!-- <span class="text-white text-2xl font-semibold">PWDi</span> -->
                    </div>
                </a>

                <div class="hidden md:flex items-center space-x-4">
                    <!-- <a href="homepage.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Home</a> -->
                    <!-- <a href="#about" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Validate</a> -->
                    <!-- <div class="relative group">
                        <button class="text-gray-300 group-hover:text-white px-3 py-2 rounded-md text-sm font-medium inline-flex items-center">
                            <span>Validate</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div class="dropdown-content absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                            <a href="Luzon.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-md">Luzon</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Visayas</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-md">Mindanao</a>
                        </div>
                    </div> -->
                    <a href="homepage.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Verify PWD ID</a>
                    <a href="feedback.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Contact</a>
                    <a href="admin-login.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Admin Login</a>
                    <!-- Dropdown Menu -->
                    <!-- <div class="relative group">
                        <button class="text-gray-300 group-hover:text-white px-3 py-2 rounded-md text-sm font-medium inline-flex items-center">
                            <span>More</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div class="dropdown-content absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-md">Profile</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                            <a href="feedback.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-md">Feedback   </a>
                            <a href="admin-login.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-md">Login</a>
                        </div>
                    </div> -->
                    <!-- <a href="admin-login.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-md">Login</a> -->
                </div>

                <!-- Mobile Menu Button (for responsiveness)-->
                <div class="md:hidden">
                    <button type="button" class="mobile-menu-button inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu (para responsive)-->
            <div class="mobile-menu hidden md:hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#home" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Home</a>
                    <a href="#about" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">About</a>
                    <a href="#services" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Services</a>
                    <a href="#" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Profile</a>
                    <a href="#" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Settings</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto mt-10 p-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold text-center text-[#1B3A57] mb-8">We Need Your Feedback</h1>

            <div class="space-y-6">
                <!-- Name Field (not required) -->
                <div>
                    <label for="feedback-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input
                        type="text"
                        id="feedback-name"
                        class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-[#1B3A57] focus:border-[#1B3A57]"
                        placeholder="Enter your name if you wish"
                    >
                </div>

                <!-- Email Field (not required) -->
                <div>
                    <label for="feedback-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input
                        type="email"
                        id="feedback-email"
                        class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-[#1B3A57] focus:border-[#1B3A57]"
                        placeholder="Enter your email if you wish"
                    >
                </div>

                <!-- Star Rating Field (required) -->
                <div>
                    <label for="star-rating" class="block text-sm font-medium text-gray-700">
                        Rating <span class="text-red-500">*</span>
                    </label>
                    <div class="flex items-center mt-2">
                        <div id="star-rating" class="flex">
                            <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400" data-rating="1">★</button>
                            <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400" data-rating="2">★</button>
                            <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400" data-rating="3">★</button>
                            <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400" data-rating="4">★</button>
                            <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400" data-rating="5">★</button>
                        </div>
                        <input type="hidden" id="feedback-stars" name="rating" value="" required>
                        <span id="rating-error" class="ml-2 text-sm text-red-500 hidden">Please select a rating</span>
                    </div>
                </div>

                <!-- Message Field (required) -->
                <div>
                    <label for="feedback-message" class="block text-sm font-medium text-gray-700">Message</label>
                    <textarea
                        id="feedback-message"
                        rows="4"
                        class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-[#1B3A57] focus:border-[#1B3A57]"
                        placeholder="Please share your thoughts..."
                        required
                    ></textarea>
                    <div class="flex items-center mt-2">
                        <button id="start-speech-to-text" type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded inline-flex items-center">
                            <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0-8a6 6 0 1 1 0 12 6 6 0 0 1 0-12z"/></svg>
                            <span>Speak</span>
                        </button>
                        <span id="recording-indicator" class="hidden ml-2 inline-flex items-center">
                          <span class="animate-pulse text-red-600 mr-1">●</span> Recording...
                        </span>
                        <span id="language-detected" class="ml-2 text-sm text-gray-500 hidden"></span>
                    </div>
                </div>

                <!-- Submit Button Section - Update to include Clear button -->
                <div class="flex gap-4">
                    <button
                        type="button"
                        id="clear-feedback"
                        class="mt-4 w-full bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                    >
                        Clear Fields
                    </button>
                    <button
                        type="submit"
                        class="mt-4 w-full bg-[#1B3A57] text-white py-2 px-4 rounded-md hover:bg-[#2C5A84] focus:outline-none focus:ring-2 focus:ring-[#1B3A57] focus:ring-offset-2"
                    >
                        Submit Feedback
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/homepage.js"></script>
    <script src="../js/verify.js"></script>

    <!-- Save form data to localStorage para ig refresh kay ma retain ang content sa feedback page if wala pa na save -->
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        // Restore form data
        document.getElementById('feedback-name').value = localStorage.getItem('feedback-name') || '';
        document.getElementById('feedback-email').value = localStorage.getItem('feedback-email') || '';
        document.getElementById('feedback-stars').value = localStorage.getItem('feedback-stars') || '';
        document.getElementById('feedback-message').value = localStorage.getItem('feedback-message') || '';
      });

      // Save on input/change
      document.getElementById('feedback-name').addEventListener('input', e => {
        localStorage.setItem('feedback-name', e.target.value);
      });
      document.getElementById('feedback-email').addEventListener('input', e => {
        localStorage.setItem('feedback-email', e.target.value);
      });
      document.getElementById('feedback-stars').addEventListener('change', e => {
        localStorage.setItem('feedback-stars', e.target.value);
      });
      document.getElementById('feedback-message').addEventListener('input', e => {
        localStorage.setItem('feedback-message', e.target.value);
      });

      
      // Speech to text
      const speechToTextButton = document.getElementById('start-speech-to-text');
      const feedbackMessage = document.getElementById('feedback-message');
      const recordingIndicator = document.getElementById('recording-indicator');
       const languageDetected = document.getElementById('language-detected');
      let recognizing = false;

      if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.maxAlternatives = 3; // Increased for better recognition
        
        // Start with empty string for auto-detection, but set Philippine language preferences
        recognition.lang = '';
        
        // Philippine languages to try if auto-detection fails
        const philippineLanguages = ['fil-PH', 'tl-PH', 'ceb-PH', 'en-PH'];
        let currentLanguageIndex = 0;
        let detectionAttempts = 0;
        const MAX_DETECTION_ATTEMPTS = 3;

        let finalTranscript = '';
        let lastResultTimestamp = 0;
        const SHORT_PAUSE_THRESHOLD = 750; // milliseconds for comma
        const LONG_PAUSE_THRESHOLD = 1500; // milliseconds for period
        
        // Enhanced language map with more Philippine language variations
        const languageNames = {
          'en-US': 'English (US)',
          'en-PH': 'English (Philippines)',
          'fil': 'Filipino',
          'fil-PH': 'Filipino',
          'tl': 'Tagalog',
          'tl-PH': 'Tagalog',
          'ceb': 'Cebuano/Bisaya',
          'ceb-PH': 'Cebuano/Bisaya',
          'war': 'Waray',
          'war-PH': 'Waray',
          'ilo': 'Ilocano',
          'ilo-PH': 'Ilocano',
          'hil': 'Hiligaynon',
          'hil-PH': 'Hiligaynon'
        };
        
        // Add a manual language selector that shows up if auto-detection fails repeatedly
        const createLanguageSelector = () => {
          if (document.getElementById('manual-language-select')) return;
          
          const container = document.createElement('div');
          container.className = 'mt-2 flex items-center';
          container.id = 'language-selector-container';
          
          const label = document.createElement('label');
          label.textContent = 'Select language: ';
          label.className = 'text-sm text-gray-700 mr-2';
          
          const select = document.createElement('select');
          select.id = 'manual-language-select';
          select.className = 'border border-gray-300 rounded py-1 px-2 text-sm';
          
          // Add Philippine language options
          for (const lang in languageNames) {
            if (philippineLanguages.some(pl => lang.startsWith(pl.split('-')[0]))) {
              const option = document.createElement('option');
              option.value = lang;
              option.textContent = languageNames[lang];
              select.appendChild(option);
            }
          }
          
          select.addEventListener('change', () => {
            recognition.lang = select.value;
            languageDetected.textContent = `Selected: ${languageNames[select.value] || select.value}`;
            languageDetected.classList.remove('hidden');
          });
          
          container.appendChild(label);
          container.appendChild(select);
          
          // Insert after the recording button
          recordingIndicator.parentNode.parentNode.appendChild(container);
        };

        speechToTextButton.addEventListener('click', () => {
          if (recognizing) {
            recognition.stop();
          } else {
            // Keep previous transcript if already present
            finalTranscript = feedbackMessage.value || "";
            lastResultTimestamp = Date.now();
            
            // Reset detection attempts
            detectionAttempts = 0;
            currentLanguageIndex = 0;
            
            // Use selected language if manually set, otherwise auto-detect
            const manualSelect = document.getElementById('manual-language-select');
            if (manualSelect && manualSelect.value) {
              recognition.lang = manualSelect.value;
            } else {
              recognition.lang = '';
            }
            
            recognition.start();
          }
        });

        recognition.onstart = () => {
          recognizing = true;
          speechToTextButton.textContent = 'Stop';
          speechToTextButton.classList.remove('bg-gray-200', 'hover:bg-gray-300');
          speechToTextButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
          recordingIndicator.classList.remove('hidden');
          languageDetected.classList.add('hidden'); // Hide language initially
        };
        
        // Enhanced language detection
        recognition.onlanguagechange = (event) => {
          const detectedLang = recognition.lang;
          if (detectedLang) {
            const displayName = languageNames[detectedLang] || detectedLang;
            languageDetected.textContent = `Detected: ${displayName}`;
            languageDetected.classList.remove('hidden');
          }
        };

        recognition.onresult = (event) => {
          // Improved language detection
          let detectedLang = '';
          for (let i = 0; i < event.results.length; i++) {
            if (event.results[i].lang) {
              detectedLang = event.results[i].lang;
              break;
            }
          }
          
          if (detectedLang) {
            const displayName = languageNames[detectedLang] || detectedLang;
            languageDetected.textContent = `Detected: ${displayName}`;
            languageDetected.classList.remove('hidden');
            detectionAttempts = 0; // Reset attempts counter if we detected something
          } else {
            detectionAttempts++;
            
            // If multiple attempts fail to detect language, try Philippine languages explicitly
            if (detectionAttempts >= MAX_DETECTION_ATTEMPTS) {
              // Show manual selector after multiple failed auto-detections
              createLanguageSelector();
              
              // Try next Philippine language in the list
              if (currentLanguageIndex < philippineLanguages.length) {
                recognition.lang = philippineLanguages[currentLanguageIndex];
                currentLanguageIndex++;
                
                languageDetected.textContent = `Trying: ${languageNames[recognition.lang] || recognition.lang}`;
                languageDetected.classList.remove('hidden');
              }
            }
          }
          
          // Rest of the existing code for handling the transcription
          let interimTranscript = '';
          const currentTime = Date.now();
          const pauseDuration = currentTime - lastResultTimestamp;
          
          // Process results - existing code unchanged
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
              // Add punctuation based on pause duration
              let segment = event.results[i][0].transcript;
              
              // Only add punctuation if we already have some text
              if (finalTranscript.trim().length > 0) {
                if (pauseDuration > LONG_PAUSE_THRESHOLD) {
                  // Long pause - add period and capitalize next word
                  finalTranscript = finalTranscript.trim() + ". ";
                  segment = segment.charAt(0).toUpperCase() + segment.slice(1);
                } else if (pauseDuration > SHORT_PAUSE_THRESHOLD) {
                  // Short pause - add comma
                  finalTranscript = finalTranscript.trim() + ", ";
                } else {
                  // No significant pause - just add space
                  finalTranscript = finalTranscript.trim() + " ";
                }
              }
              
              finalTranscript += segment + " ";
              lastResultTimestamp = currentTime;
            } else {
              interimTranscript += event.results[i][0].transcript;
            }
          }
          
          // Display both final and interim results
          feedbackMessage.value = finalTranscript;
          
          // Add the interim text with typing animation
          if (interimTranscript) {
            // Create typing animation by adding one character at a time with a small delay
            let currentText = feedbackMessage.value;
            let charIndex = 0;
            
            const typeInterim = () => {
              if (charIndex < interimTranscript.length) {
                feedbackMessage.value = currentText + interimTranscript.substring(0, charIndex + 1);
                charIndex++;
                setTimeout(typeInterim, 50); // Typing speed - adjust as needed
              }
            };
            
            typeInterim();
          }
          
          localStorage.setItem('feedback-message', finalTranscript);
        };

        // Ensure first letter of transcript is capitalized
        function capitalizeFirstLetter(text) {
          if (text.length === 0) return text;
          return text.charAt(0).toUpperCase() + text.slice(1);
        }
        
        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          recognizing = false;
          speechToTextButton.textContent = 'Speak';
          speechToTextButton.classList.add('bg-gray-200', 'hover:bg-gray-300');
          speechToTextButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white');
          recordingIndicator.classList.add('hidden');
        };

        recognition.onend = () => {
          recognizing = false;
          speechToTextButton.textContent = 'Speak';
          speechToTextButton.classList.add('bg-gray-200', 'hover:bg-gray-300');
          speechToTextButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white');
          recordingIndicator.classList.add('hidden');
          
          // Ensure the final transcript is preserved in the textarea
          if (finalTranscript.length > 0) {
            // Capitalize first letter if needed
            if (/^[a-z]/.test(finalTranscript)) {
              finalTranscript = capitalizeFirstLetter(finalTranscript);
            }
            
            // Make sure the text stays in the textarea
            feedbackMessage.value = finalTranscript;
            localStorage.setItem('feedback-message', finalTranscript);
          }
        };
      } else {
        speechToTextButton.disabled = true;
        speechToTextButton.textContent = 'Speech to Text not supported';
      }
    </script>
    <!-- Add this to the existing script section -->
    <script>
      // Add clear button functionality
      document.getElementById('clear-feedback').addEventListener('click', () => {
        // Clear all form fields
        document.getElementById('feedback-name').value = '';
        document.getElementById('feedback-email').value = '';
        document.getElementById('feedback-stars').value = '';
        document.getElementById('feedback-message').value = '';
        
        // Clear localStorage items
        localStorage.removeItem('feedback-name');
        localStorage.removeItem('feedback-email');
        localStorage.removeItem('feedback-stars');
        localStorage.removeItem('feedback-message');
        
        // Show confirmation message
        const messageElement = document.createElement('div');
        messageElement.className = 'mt-2 text-sm text-green-600';
        messageElement.textContent = 'All fields have been cleared';
        
        // Insert the message after the buttons
        const buttonsContainer = document.getElementById('clear-feedback').parentNode;
        buttonsContainer.parentNode.insertBefore(messageElement, buttonsContainer.nextSibling);
        
        // Remove the message after 3 seconds
        setTimeout(() => {
          if (messageElement.parentNode) {
            messageElement.parentNode.removeChild(messageElement);
          }
        }, 3000);
      });
    </script>
    <!-- Add this script section right after the existing scripts, before the closing </body> tag -->

<!-- Update the Star rating functionality script to include hover behavior -->
<script>
  // Star rating functionality
  document.addEventListener('DOMContentLoaded', () => {
    const starButtons = document.querySelectorAll('.star-btn');
    const feedbackStarsInput = document.getElementById('feedback-stars');
    let savedRatingValue = 0;
    
    // Apply saved rating from localStorage when page loads
    const savedRating = localStorage.getItem('feedback-stars');
    if (savedRating) {
      savedRatingValue = parseInt(savedRating);
      updateStars(savedRatingValue);
    }
    
    // Add click handlers to each star
    starButtons.forEach(button => {
      button.addEventListener('click', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        savedRatingValue = rating;
        updateStars(rating);
        feedbackStarsInput.value = rating;
        localStorage.setItem('feedback-stars', rating);
        
        // Hide error message if it's showing
        document.getElementById('rating-error').classList.add('hidden');
      });
      
      // Add hover handlers to create the "fill to the left" effect
      button.addEventListener('mouseenter', function() {
        const hoverRating = parseInt(this.getAttribute('data-rating'));
        highlightStars(hoverRating);
      });
      
      button.addEventListener('mouseleave', function() {
        // When mouse leaves, revert to the saved rating
        updateStars(savedRatingValue);
      });
    });
    
    // Function to update star appearance based on selected rating
    function updateStars(rating) {
      starButtons.forEach(button => {
        const buttonRating = parseInt(button.getAttribute('data-rating'));
        if (buttonRating <= rating) {
          button.classList.remove('text-gray-300');
          button.classList.add('text-yellow-400');
        } else {
          button.classList.remove('text-yellow-400');
          button.classList.add('text-gray-300');
        }
      });
    }
    
    // Function to temporarily highlight stars on hover
    function highlightStars(rating) {
      starButtons.forEach(button => {
        const buttonRating = parseInt(button.getAttribute('data-rating'));
        if (buttonRating <= rating) {
          button.classList.remove('text-gray-300');
          button.classList.add('text-yellow-400');
        } else {
          button.classList.remove('text-yellow-400');
          button.classList.add('text-gray-300');
        }
      });
    }
  });
  
  // Update the clear button functionality to also reset stars
  const originalClearHandler = document.getElementById('clear-feedback').onclick;
  document.getElementById('clear-feedback').onclick = function() {
    // Call the original handler first
    if (originalClearHandler) originalClearHandler();
    
    // Reset star colors
    const starButtons = document.querySelectorAll('.star-btn');
    starButtons.forEach(button => {
      button.classList.remove('text-yellow-400');
      button.classList.add('text-gray-300');
    });
    
    // Reset the saved rating value in the DOM
    document.getElementById('feedback-stars').value = '';
  };
</script>
</body>
</html>